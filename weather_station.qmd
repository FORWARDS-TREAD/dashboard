---
title: "Cardeña"
format: 
  dashboard:
    orientation: rows
    theme: journal
---

```{r setup}
#| include: false
library(ggplot2)
library(leaflet)
library(sf)
library(jsonlite)
library(dplyr)
library(stringr)
library(DT)
library(crosstalk)

# Find all JSON files in data/PPI-1 and subdirectories
json_files <- list.files(
  path = "data/PPI-1",
  pattern = "\\.json$",
  recursive = TRUE,
  full.names = TRUE
)

# Initialize list to store all sensor data
all_sensor_data <- list()
station_info <- NULL

# Read and parse each JSON file
for (json_path in json_files) {
  raw_json <- fromJSON(json_path, flatten = TRUE)

  # Extract station info (from first file)
  if (is.null(station_info)) {
    station_name <- raw_json$data$nombre[[1]]
    station_id <- raw_json$data$id_elemento[[1]]
    station_info <- list(name = station_name, id = station_id)
  }

  # Extract sensors data
  sensors <- raw_json$data$sensores[[1]]

  # Flatten sensor data for each sensor in this file
  for (i in seq_len(nrow(sensors))) {
    sensor_id <- sensors$id_sensor_raw[i]
    param_name <- sensors$parametro[i]
    datos <- sensors$datos[[i]]
    source_file <- basename(json_path)

    if (nrow(datos) > 0) {
      temp_df <- datos |>
        mutate(
          sensor_id = sensor_id,
          parameter = param_name,
          source_file = source_file
        )
      all_sensor_data[[length(all_sensor_data) + 1]] <- temp_df
    }
  }
}

# Combine all sensor data
df_sensors <- bind_rows(all_sensor_data) |>
  rename(value = valor_raw) |>
  mutate(
    datetime = as.POSIXct(fecha_raw, format = "%Y-%m-%d %H:%M", tz = ""),
    date = as.Date(fecha_raw, format = "%Y-%m-%d"),
    hour = format(datetime, "%H:%M"),
    value = as.numeric(value)
  ) |>
  select(sensor_id, parameter, date, hour, value, datetime, source_file)

# Extract station info for later use
station_name <- station_info$name
station_id <- station_info$id

# Station coordinates (approximate for PPI-1 Cardeña - Sierra Nevada area)
station_lon <- -3.05
station_lat <- 37.85

# Create sf object for the station
station_point <- st_sfc(
  st_point(c(station_lon, station_lat)),
  crs = 4326
) |>
  st_sf(
    name = station_name,
    id = station_id,
    geometry = _
  )

# Create shared data
shared_data <- SharedData$new(df_sensors)

# Calculate statistics
total_readings <- nrow(df_sensors)
unique_sensors <- n_distinct(df_sensors$parameter)
```

# Station Overview {orientation="columns"}

## Column {width=65%}
```{r}
#| title: "Station Location Map"
#| padding: 0

leaflet() |>
  addProviderTiles(providers$Esri.WorldTopoMap) |>
  addCircleMarkers(
    data = station_point,
    radius = 12,
    color = "red",
    weight = 2,
    fillOpacity = 0.8,
    popup = ~ str_glue("<strong>Station:</strong> {name}<br>ID: {id}"),
    label = ~name
  ) |>
  addLegend(
    position = "bottomright",
    colors = "red",
    labels = "Weather Station",
    title = "Monitoring Point"
  )
```

## Column {width=35%}
```{r}
#| title: "Readings by Parameter"
#| height: 80%

# Aggregate readings by parameter
param_counts <- df_sensors |>
  count(parameter, name = "readings") |>
  arrange(desc(readings))

ggplot(
  param_counts,
  aes(
    x = reorder(parameter, -readings),
    y = readings,
    fill = parameter
  )
) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_d() +
  theme_minimal(base_size = 12) +
  labs(
    x = NULL,
    y = "Number of Readings"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    panel.grid.major.x = element_blank()
  )
```

### Row {height=20%}
```{r}
#| title: "Total Readings"
#| content: valuebox
#| icon: chart-bar

list(
  color = "primary",
  value = total_readings
)
```

```{r}
#| title: "Active Sensors"
#| content: valuebox
#| icon: gear

list(
  color = "success",
  value = unique_sensors
)
```

# Sensor Data

## {.sidebar width=25% position="right"}
```{r}
# Filter widgets (client-side, no server required)
filter_slider(
  "filter_date",
  "Date",
  shared_data,
  ~date,
  width = "90%",
  dragRange = TRUE
)

filter_select(
  "filter_parameter",
  "Parameter",
  shared_data,
  ~parameter,
  multiple = TRUE
)
```

## Column {width=75%}
```{r}
#| title: "All Sensor Readings"

datatable(
  shared_data,
  extensions = "Buttons",
  options = list(
    pageLength = 15,
    dom = 'Btip',
    columnDefs = list(list(targets = c(-2, -1), visible = FALSE)),
    order = list(list(2, "asc"), list(3, "asc")),
    buttons = list(
      list(
        extend = "csv",
        filename = str_c("weather_station_", station_id),
        title = NULL,
        exportOptions = list(columns = ":visible")
      ),
      list(
        extend = "excel",
        filename = str_c("weather_station_", station_id),
        title = NULL,
        exportOptions = list(columns = ":visible")
      )
    )
  ),
  colnames = c(
    "Sensor ID",
    "Parameter",
    "Date",
    "Hour",
    "Value",
    "Timestamp",
    "Source file"
  ),
  rownames = FALSE
) |>
  formatRound(columns = "value", digits = 3)
```
